import{b as n,q as M,x as R,j as r,G as I,r as P}from"./app-4a17Pub4.js";import{c as m,D as A,a as F}from"./TaskDrawer.module-YBHG2sMu.js";import{R as Y}from"./RichTextEditor-Cn3FPVCj.js";import{u as G}from"./useTaskDrawerStore-6UMOKvwU.js";import{u as W}from"./useTasksStore-BPRaRGpQ.js";import{a as q}from"./useWebSockets-DKQQzHQQ.js";import{b as H}from"./datetime-DXAmRnuk.js";import{h as L}from"./user-IyQLa11_.js";import U from"./Comments-DCXjcLG-.js";import V from"./LabelsDropdown-Db3CEi_I.js";import J from"./Timer-DBequ3Y2.js";import{D as K}from"./Drawer-49D35R63.js";import{C as b}from"./Checkbox-CVY_-4jR.js";import{T as l}from"./Text-BR9LnClf.js";import{B as Q}from"./Breadcrumbs-DnTwgQ8t.js";import{T as X}from"./TextInput-h0GXyFQ7.js";import{S as T}from"./Select-B1v7hLJR.js";import{N as Z}from"./NumberInput-DH4hLPlt.js";import{M as $}from"./MultiSelect-Duq5FJlZ.js";import"./file-D4aCAaTQ.js";import"./upper-first-sQkIoMXG.js";import"./use-resolved-styles-api-nyfOONey.js";import"./use-disclosure-CdCiEhD4.js";import"./ConfirmModal-gDH_QAL7.js";import"./IconCircleX-irk6tkAo.js";import"./createReactComponent-BwHUzXp6.js";import"./Image-BIx1LFvX.js";import"./Center-CanggSuC.js";import"./IconX-DRbAGJ5J.js";import"./SimpleGrid-D_xH_exl.js";import"./get-sorted-breakpoints-RaBjtxFS.js";import"./get-base-value-JqT_q0U7.js";import"./pick-calendar-levels-props-4bDM8Nej.js";import"./use-uncontrolled-BGuEEBtS.js";import"./AccordionChevron-CiAWs_wK.js";import"./clamp-DTmYCdls.js";import"./InputBase-DVeQGwl5.js";import"./Input-B6kN7ymh.js";import"./create-optional-context-DejgPxvx.js";import"./Popover-CBbffI_i.js";import"./DirectionProvider-DqDMRz46.js";import"./use-floating-auto-update-BytyxRVS.js";import"./use-computed-color-scheme-BjX3e8Yz.js";import"./Tooltip-Bs0FEF2V.js";import"./get-style-object-DUJZA7T_.js";import"./ColorSwatch-HXcgr9nk.js";import"./ColorPicker-C94QZAI7.js";import"./ActionIcon-ni5mTX2i.js";import"./route-CLXYwALx.js";import"./_baseClone-DIFX3Exu.js";import"./index-C163xbN1.js";import"./reorder-DWLP_Jze.js";import"./useTaskGroupsStore-jTNmh8Xp.js";import"./Title-BSH3ecI3.js";import"./Flex-C4-MgrqI.js";import"./Stack-B-kostaa.js";import"./Avatar-VVVl2UCZ.js";import"./Label-CpZa6cUd.js";import"./Combobox-Bd-ojIJS.js";import"./PillsInput-B9htvQA-.js";import"./Pill-BLrl2ix2.js";import"./CheckIcon-BVmRy-LG.js";import"./IconPlus-BCylK9as.js";import"./Divider-DR6Vztcl.js";import"./get-auto-contrast-value-Da6zqqWm.js";import"./OptionsDropdown-B7k9BRCW.js";import"./ScrollArea-BBLLgi1y.js";function ut(){var j;const h=n.useRef(null),{edit:a,openEditTask:S,closeEditTask:C}=G(),{initTaskWebSocket:D}=q(),{findTask:v,updateTaskProperty:d,complete:y,deleteAttachment:k,uploadAttachments:w}=W(),{usersWithAccessToProject:c,taskGroups:E,labels:g,openedTask:f,auth:{user:N}}=M().props;n.useEffect(()=>{f&&setTimeout(()=>S(f),50)},[]);const e=v(a.task.id),[i,_]=n.useState({group_id:"",assigned_to_user_id:"",name:"",description:"",estimation:0,due_on:"",hidden_from_clients:!1,billable:!0,subscribed_users:[],labels:[]});n.useEffect(()=>{if(a.opened)return D(e)},[a.opened]),n.useEffect(()=>{var t;a.opened&&(_({group_id:(e==null?void 0:e.group_id)||"",assigned_to_user_id:(e==null?void 0:e.assigned_to_user_id)||"",name:(e==null?void 0:e.name)||"",description:(e==null?void 0:e.description)||"",estimation:(e==null?void 0:e.estimation)||0,due_on:e!=null&&e.due_on?R(e==null?void 0:e.due_on).toDate():"",hidden_from_clients:(e==null?void 0:e.hidden_from_clients)!==void 0?e.hidden_from_clients:!1,billable:(e==null?void 0:e.billable)!==void 0?e.billable:!0,subscribed_users:((e==null?void 0:e.subscribed_users)||[]).map(s=>s.id.toString()),labels:((e==null?void 0:e.labels)||[]).map(s=>s.id)}),(t=h.current)==null||t.setContent((e==null?void 0:e.description)||""))},[a.opened,e]);const o=(t,s)=>{_({...i,[t]:s});const O=["labels","subscribed_users"],z=["name","description"];if(O.includes(t)){const B={labels:s.map(p=>g.find(u=>u.id===p)),subscribed_users:s.map(p=>c.find(u=>u.id.toString()===p))};d(e,t,s,B[t])}else z.includes(t)||d(e,t,s)},x=t=>{i.name.length>0&&d(e,t,i[t])};return r.jsx(K,{opened:a.opened,onClose:C,title:r.jsxs(I,{ml:25,my:"sm",wrap:"nowrap",children:[r.jsx(b,{size:"md",radius:"xl",color:"green",checked:(e==null?void 0:e.completed_at)!==null,onChange:t=>y(e,t.currentTarget.checked),className:can("complete task")?m.checkbox:m.disabledCheckbox}),r.jsxs(l,{fz:P(27),fw:600,lh:1.2,td:(e==null?void 0:e.completed_at)!==null?"line-through":null,children:["#",e==null?void 0:e.number,": ",i.name]})]}),position:"right",size:1e3,overlayProps:{backgroundOpacity:.55,blur:3},transitionProps:{transition:"slide-left",duration:400,timingFunction:"ease"},children:e?r.jsxs(r.Fragment,{children:[r.jsxs(Q,{c:"dark.3",ml:24,mb:"xs",separator:"I",separatorMargin:"sm",styles:{separator:{opacity:.3}},children:[r.jsx(l,{size:"xs",children:e.project.name}),r.jsxs(l,{size:"xs",children:["Task #",e.number]}),r.jsxs(l,{size:"xs",children:["Created by ",e.created_by_user.name," on ",H(e.created_at)]})]}),r.jsxs("form",{className:m.inner,children:[r.jsxs("div",{className:m.content,children:[r.jsx(X,{label:"Name",placeholder:"Task name",value:i.name,onChange:t=>o("name",t.target.value),onBlur:()=>x("name"),error:i.name.length===0,readOnly:!can("edit task")}),r.jsx(Y,{ref:h,mt:"xl",placeholder:"Task description",content:i.description,height:260,onChange:t=>o("description",t),onBlur:()=>x("description"),readOnly:!can("edit task")}),can("edit task")&&r.jsx(A,{mt:"xl",selected:e.attachments,onChange:t=>w(e,t),remove:t=>k(e,t)}),can("view comments")&&r.jsx(U,{task:e})]}),r.jsxs("div",{className:m.sidebar,children:[r.jsx(T,{label:"Task group",placeholder:"Select task group",allowDeselect:!1,value:i.group_id.toString(),onChange:t=>o("group_id",t),data:E.map(t=>({value:t.id.toString(),label:t.name})),readOnly:!can("edit task")}),r.jsx(T,{label:"Assignee",placeholder:"Select assignee",searchable:!0,mt:"md",value:(j=i.assigned_to_user_id)==null?void 0:j.toString(),onChange:t=>o("assigned_to_user_id",t),data:c.map(t=>({value:t.id.toString(),label:t.name})),readOnly:!can("edit task")}),r.jsx(F,{clearable:!0,valueFormat:"DD MMM YYYY",minDate:new Date,mt:"md",label:"Due date",placeholder:"Pick task due date",value:i.due_on,onChange:t=>o("due_on",t),readOnly:!can("edit task")}),r.jsx(V,{items:g,selected:i.labels,onChange:t=>o("labels",t),mt:"md"}),r.jsx(Z,{label:"Time estimation",mt:"md",decimalScale:2,fixedDecimalScale:!0,value:i.estimation,min:0,allowNegative:!1,step:.5,suffix:" hours",onChange:t=>o("estimation",t),readOnly:!can("edit task")}),(can("view time logs")||can("add time log"))&&r.jsx(J,{mt:"xl",task:e}),r.jsx(b,{label:"Billable",mt:"xl",checked:i.billable,onChange:t=>o("billable",t.currentTarget.checked),disabled:!can("edit task")}),!L(N,["client"])&&r.jsx(b,{label:"Hidden from clients",mt:"md",checked:i.hidden_from_clients,onChange:t=>o("hidden_from_clients",t.currentTarget.checked),disabled:!can("edit task")}),r.jsx($,{label:"Subscribers",placeholder:i.subscribed_users.length?null:"Select subscribers",mt:"lg",value:i.subscribed_users,onChange:t=>o("subscribed_users",t),data:c.map(t=>({value:t.id.toString(),label:t.name})),readOnly:!can("edit task")})]})]})]}):r.jsx(r.Fragment,{})})}export{ut as EditTaskDrawer};
